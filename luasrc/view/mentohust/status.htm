<%+header%>
<style>
.mentohust-log {
    background-color: #1e1e1e;
    color: #d4d4d4;
    padding: 10px;
    border-radius: 3px;
    font-family: Consolas, Menlo, Monaco, "Courier New", monospace;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    height: 450px;
    overflow-y: scroll;
    border: 1px solid #444;
}
.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
}
.status-green { background-color: #4caf50; box-shadow: 0 0 5px #4caf50; }
.status-red { background-color: #f44336; box-shadow: 0 0 5px #f44336; }

.cbi-button-clear {
    background-color: #e7604a; 
    color: #fff;
    border: 1px solid #d44a36;
}
.cbi-button-clear:hover {
    background-color: #d44a36;
}
.cbi-button-row {
    display: flex;
    gap: 10px;
    padding: 10px 0;
    align-items: center;
}
</style>
<h2 name="content"><%:MentoHUST 802.1x 认证%></h2>
<div class="cbi-map">
    <fieldset class="cbi-section">
        <legend><%:运行状态%></legend>
        <div class="cbi-section-node">
            <div class="cbi-value">
                <label class="cbi-value-title"><%:服务状态%></label>
                <div class="cbi-value-field">
                    <span id="status_icon" class="status-indicator" style="background-color: #ccc;"></span>
                    <span id="status_text" style="font-weight: bold; vertical-align: middle;"><%:检测中...%></span>
                </div>
            </div>
            <div class="cbi-value cbi-value-last">
                <label class="cbi-value-title"><%:开机自启%></label>
                <div class="cbi-value-field">
                    <span id="enabled_text"><%:检测中...%></span>
                </div>
            </div>
        </div>
    </fieldset>
    <fieldset class="cbi-section">
        <legend><%:服务控制%></legend>
        <div class="cbi-section-node">
            <div class="cbi-button-row">
                <button type="button" class="cbi-button cbi-button-reset" onclick="action('stop')"><%:停止服务%></button>
                <button type="button" class="cbi-button cbi-button-reload" onclick="action('restart')"><%:重启服务%></button>
                <button type="button" class="cbi-button cbi-button-clear" onclick="clearLog()"><%:清除日志%></button>
                <button type="button" class="cbi-button cbi-button-link" onclick="updateLog()"><%:刷新日志%></button>
            </div>
        </div>
    </fieldset>
    <fieldset class="cbi-section">
        <legend>
            <%:实时日志%> 
        </legend>
        <div class="cbi-section-node">
            <textarea id="log_area" class="mentohust-log" readonly><%:正在加载日志...%></textarea>
            <div style="margin-top: 5px; text-align: right; color: #888; font-size: 0.8em;">
                <%:仅显示最后 100 行运行日志 (From /tmp/mentohust.log)%>
            </div>
        </div>
    </fieldset>
</div>
<script type="text/javascript">//<![CDATA[
    var statusIcon = document.getElementById('status_icon');
    var statusText = document.getElementById('status_text');
    var enabledText = document.getElementById('enabled_text');
    var logArea = document.getElementById('log_area');
    function getTs() { return '?t=' + Math.random(); }
    
    // 状态更新
    function updateStatus() {
        XHR.get('<%=url("admin/services/mentohust/get_status")%>' + getTs(), null, function(x, data) {
            if (data) {
                if (data.running) {
                    statusIcon.className = 'status-indicator status-green';
                    statusText.innerHTML = '<%:运行中 (Running)%>';
                    statusText.style.color = '#4caf50';
                } else {
                    statusIcon.className = 'status-indicator status-red';
                    statusText.innerHTML = '<%:已停止 (Stopped)%>';
                    statusText.style.color = '#f44336';
                }
                if (data.enabled) {
                    enabledText.innerHTML = '<span style="color:green;font-weight:bold"><%:已启用 (Enabled)%></span>';
                } else {
                    enabledText.innerHTML = '<span style="color:red"><%:未启用 (Disabled)%></span>';
                }
            }
        });
    }

    // 日志更新
    function updateLog() {
        XHR.get('<%=url("admin/services/mentohust/get_log")%>' + getTs(), null, function(x, data) {
            if (x.responseText) {
                if (logArea.value !== x.responseText) {
                    logArea.value = x.responseText;
                    logArea.scrollTop = logArea.scrollHeight;
                }
            } else {
                logArea.value = '<%:暂无日志数据%>';
            }
        });
    }
    
    // 服务操作
    function action(act) {
        if (act === 'stop') console.log("Attempting to stop MentoHUST service.");
        
        if (act === 'restart') {
            statusText.innerHTML = '<%:重启中...%>';
            statusText.style.color = '#e6a23c';
            statusIcon.style.backgroundColor = '#e6a23c';
        }

        XHR.post('<%=url("admin/services/mentohust/service_action")%>' + getTs(), {action: act}, function(x, data) {
            if (data && data.success) {
                console.log('Service action "' + act + '" successful.');
                setTimeout(function() { updateStatus(); updateLog(); }, 1500);
            } else {
                console.error('Service action "' + act + '" failed.');
                updateStatus();
            }
        });
    }

    // 清除日志
    function clearLog() {
        console.log("Attempting to clear MentoHUST log.");
        XHR.post('<%=url("admin/services/mentohust/clear_log")%>' + getTs(), {}, function(x, data) {
            if (data && data.success) {
                console.log('Log cleared successfully.');
                updateLog();
            } else {
                console.error('Failed to clear log.');
                updateLog();
            }
        });
    }

    updateStatus();
    updateLog();

    window.setInterval(function() { updateStatus(); updateLog(); }, 3000);
//]]></script>
<%+footer%>