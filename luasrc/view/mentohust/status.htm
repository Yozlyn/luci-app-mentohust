<%+header%>

<style>
.mentohust-status { padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ddd; }
.status-running { background: #d4edda; color: #155724; border-color: #c3e6cb; }
.status-stopped { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
.log-container {
    background: #2b2b2b; color: #f8f8f2;
    padding: 15px; border-radius: 5px;
    max-height: 400px; overflow-y: auto;
    font-family: Consolas, Monaco, monospace; font-size: 12px;
    white-space: pre-wrap; word-wrap: break-word;
}
</style>

<h2><a id="content" name="content">MentoHUST 802.1x 认证</a></h2>

<div id="status-box" class="mentohust-status">
    <strong>运行状态：</strong><span id="service-status">检测中...</span> &nbsp;|&nbsp; 
    <strong>开机自启：</strong><span id="service-enabled">检测中...</span>
</div>

<div class="cbi-section">
    <div class="cbi-button-group">
        <button class="cbi-button cbi-button-apply" onclick="serviceAction('start')">启动服务</button>
        <button class="cbi-button cbi-button-reset" onclick="serviceAction('stop')">停止服务</button>
        <button class="cbi-button cbi-button-reload" onclick="serviceAction('restart')">重启服务</button>
        &nbsp;&nbsp;
        <button class="cbi-button cbi-button-save" onclick="serviceAction('enable')">开启自启</button>
        <button class="cbi-button cbi-button-remove" onclick="serviceAction('disable')">关闭自启</button>
    </div>
</div>

<h3>系统日志 <small>(最后100行)</small> <button class="cbi-button cbi-button-reload" style="float:right" onclick="refreshLog()">刷新日志</button></h3>
<div id="log-content" class="log-container">正在获取日志...</div>

<script type="text/javascript">//<![CDATA[
function updateStatus() {
    XHR.get('<%=url("admin/services/mentohust/get_status")%>', null, function(x, data) {
        var statusBox = document.getElementById('status-box');
        var statusText = document.getElementById('service-status');
        var enabledText = document.getElementById('service-enabled');
        
        if (data && data.running) {
            statusBox.className = 'mentohust-status status-running';
            statusText.innerHTML = '<strong>运行中 (Running)</strong>';
        } else {
            statusBox.className = 'mentohust-status status-stopped';
            statusText.innerHTML = '<strong>已停止 (Stopped)</strong>';
        }
        
        if (data) {
            enabledText.innerHTML = data.enabled ? '已启用 (Enabled)' : '未启用 (Disabled)';
        }
    });
}

function refreshLog() {
    XHR.get('<%=url("admin/services/mentohust/get_log")%>', null, function(x, data) {
        var logDiv = document.getElementById('log-content');
        if (x.responseText) {
            logDiv.textContent = x.responseText;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    });
}

function serviceAction(action) {
    if(!confirm('确认执行 ' + action + ' 操作吗？')) return;
    
    document.getElementById('status-box').style.opacity = '0.5';
    
    XHR.post('<%=url("admin/services/mentohust/service_action")%>', {action: action}, function(x, data) {
        document.getElementById('status-box').style.opacity = '1';
        if (data && data.success) {
            setTimeout(function(){ updateStatus(); refreshLog(); }, 2000);
        } else {
            alert('操作失败或服务未响应');
        }
    });
}

updateStatus();
refreshLog();
setInterval(updateStatus, 5000);
//]]></script>

<%+footer%>
